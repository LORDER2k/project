<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard com Chart.js</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">üìä Dashboard de An√°lise de Dados</h1>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">üìà Desempenho Semanal</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">üçï Distribui√ß√£o por Categoria</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">‚è±Ô∏è Dados em Tempo Real</h5>
                    </div>
                    <div class="card-body">
                        <h3 class="text-center" id="valorTempoReal">Carregando...</h3>
                        <p class="text-center text-muted" id="horaAtual"></p>
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">üîÑ Controles</h5>
                    </div>
                    <div class="card-body">
                        <button id="atualizarBtn" class="btn btn-primary">Atualizar Dados</button>
                        <button id="adicionarSerieBtn" class="btn btn-success">Adicionar S√©rie</button>
                        <button id="removerSerieBtn" class="btn btn-danger">Remover S√©rie</button>
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="autoUpdateToggle" checked>
                            <label class="form-check-label" for="autoUpdateToggle">Atualiza√ß√£o Autom√°tica (5s)</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Elementos do DOM
        const lineChartCanvas = document.getElementById('lineChart');
        const pieChartCanvas = document.getElementById('pieChart');
        const barChartCanvas = document.getElementById('barChart');
        const valorTempoReal = document.getElementById('valorTempoReal');
        const horaAtual = document.getElementById('horaAtual');
        const atualizarBtn = document.getElementById('atualizarBtn');
        const adicionarSerieBtn = document.getElementById('adicionarSerieBtn');
        const removerSerieBtn = document.getElementById('removerSerieBtn');
        const autoUpdateToggle = document.getElementById('autoUpdateToggle');

        // Inst√¢ncias dos gr√°ficos
        let lineChart, pieChart, barChart;
        let barChartData = [];
        let autoUpdateInterval;

        // Cores para s√©ries adicionais
        const coresAdicionais = [
            'rgb(255, 159, 64)',
            'rgb(153, 102, 255)',
            'rgb(201, 203, 207)',
            'rgb(255, 205, 86)'
        ];

        // Inicializar gr√°fico de linha
        async function initLineChart() {
            const response = await fetch('/api/dados');
            const data = await response.json();
            
            lineChart = new Chart(lineChartCanvas, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Dados dos √∫ltimos 7 dias'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Inicializar gr√°fico de pizza
        async function initPieChart() {
            const response = await fetch('/api/dados-pizza');
            const data = await response.json();
            
            pieChart = new Chart(pieChartCanvas, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        // Inicializar gr√°fico de barras
        function initBarChart() {
            barChart = new Chart(barChartCanvas, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Valor em Tempo Real',
                        data: barChartData,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Atualizar dados em tempo real
        async function updateRealTimeData() {
            try {
                const response = await fetch('/api/dados-tempo-real');
                const data = await response.json();
                
                valorTempoReal.textContent = `R$ ${data.valor.toFixed(2)}`;
                horaAtual.textContent = `√öltima atualiza√ß√£o: ${data.hora}`;
                
                // Adicionar ao gr√°fico de barras
                barChartData.push(data.valor);
                if (barChartData.length > 10) {
                    barChartData.shift();
                }
                
                barChart.data.labels = Array.from({length: barChartData.length}, (_, i) => `Ponto ${i + 1}`);
                barChart.data.datasets[0].data = barChartData;
                barChart.update();
            } catch (error) {
                console.error('Erro ao atualizar dados:', error);
            }
        }

        // Atualizar todos os gr√°ficos
        async function updateAllCharts() {
            if (lineChart) {
                const response = await fetch('/api/dados');
                const data = await response.json();
                lineChart.data = data;
                lineChart.update();
            }
            
            if (pieChart) {
                const response = await fetch('/api/dados-pizza');
                const data = await response.json();
                pieChart.data = data;
                pieChart.update();
            }
            
            updateRealTimeData();
        }

        // Adicionar s√©rie ao gr√°fico de linha
        function addSeries() {
            if (!lineChart) return;
            
            const novasCores = coresAdicionais[lineChart.data.datasets.length % coresAdicionais.length];
            const novaSerie = {
                label: `S√©rie ${lineChart.data.datasets.length + 1}`,
                data: Array.from({length: 7}, () => Math.floor(Math.random() * 400) + 100),
                borderColor: novasCores,
                backgroundColor: novasCores.replace('rgb', 'rgba').replace(')', ', 0.2)'),
                tension: 0.4
            };
            
            lineChart.data.datasets.push(novaSerie);
            lineChart.update();
        }

        // Remover s√©rie do gr√°fico de linha
        function removeSeries() {
            if (!lineChart || lineChart.data.datasets.length <= 1) return;
            
            lineChart.data.datasets.pop();
            lineChart.update();
        }

        // Iniciar atualiza√ß√£o autom√°tica
        function startAutoUpdate() {
            if (autoUpdateInterval) clearInterval(autoUpdateInterval);
            autoUpdateInterval = setInterval(updateRealTimeData, 5000);
        }

        // Parar atualiza√ß√£o autom√°tica
        function stopAutoUpdate() {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
                autoUpdateInterval = null;
            }
        }

        // Event Listeners
        atualizarBtn.addEventListener('click', updateAllCharts);
        adicionarSerieBtn.addEventListener('click', addSeries);
        removerSerieBtn.addEventListener('click', removeSeries);
        
        autoUpdateToggle.addEventListener('change', function() {
            if (this.checked) {
                startAutoUpdate();
            } else {
                stopAutoUpdate();
            }
        });

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            await initLineChart();
            await initPieChart();
            initBarChart();
            updateRealTimeData();
            startAutoUpdate();
            
            // Atualizar dados a cada 30 segundos (exceto tempo real)
            setInterval(async () => {
                if (autoUpdateToggle.checked) {
                    const response = await fetch('/api/dados');
                    const data = await response.json();
                    lineChart.data = data;
                    lineChart.update();
                    
                    const responsePizza = await fetch('/api/dados-pizza');
                    const dataPizza = await responsePizza.json();
                    pieChart.data = dataPizza;
                    pieChart.update();
                }
            }, 30000);
        });
    </script>
</body>
</html>