{% extends "base_executivo.html" %}

{% block title %}IA Financeira - ContaSmart Pro{% endblock %}
{% block page_title %}Assistente de IA Financeira{% endblock %}
{% block page_subtitle %}Análise preditiva e recomendações inteligentes{% endblock %}

{% block breadcrumb %}
<li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li><a href="#">{{ 'IA Financeira' }}</a></li>
{% endblock %}

{% block extra_css %}
<style>
    /* AI Header */
    .ai-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
        padding: var(--spacing-lg);
        background: linear-gradient(135deg, var(--bg-card), var(--bg-tertiary));
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
    }
    
    .ai-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        animation: pulseGlow 2s infinite;
    }
    
    .ai-greeting h2 {
        font-size: var(--font-size-xxl);
        margin-bottom: var(--spacing-xs);
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .ai-status {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
    }
    
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success-color);
        animation: pulse 2s infinite;
    }
    
    /* Recommendations Grid */
    .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }
    
    .recommendation-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        position: relative;
        overflow: hidden;
        transition: all var(--transition-normal);
    }
    
    .recommendation-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--elevation-3);
    }
    
    .recommendation-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }
    
    .recommendation-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }
    
    .recommendation-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--border-radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    .recommendation-success .recommendation-icon {
        background: rgba(0, 255, 136, 0.1);
        color: var(--success-color);
    }
    
    .recommendation-warning .recommendation-icon {
        background: rgba(255, 153, 0, 0.1);
        color: var(--warning-color);
    }
    
    .recommendation-danger .recommendation-icon {
        background: rgba(255, 51, 102, 0.1);
        color: var(--danger-color);
    }
    
    .recommendation-info .recommendation-icon {
        background: rgba(0, 204, 255, 0.1);
        color: var(--info-color);
    }
    
    .recommendation-title {
        font-size: var(--font-size-base);
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .recommendation-description {
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
        line-height: 1.5;
        margin-bottom: var(--spacing-md);
    }
    
    .recommendation-action {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        color: var(--text-primary);
        text-decoration: none;
        font-size: var(--font-size-sm);
        transition: all var(--transition-fast);
    }
    
    .recommendation-action:hover {
        background: var(--bg-surface);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    /* Chat Interface */
    .chat-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        margin-bottom: var(--spacing-xl);
        overflow: hidden;
    }
    
    .chat-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-messages {
        height: 400px;
        overflow-y: auto;
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
    }
    
    .message {
        max-width: 80%;
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--border-radius-lg);
        position: relative;
        animation: fadeIn 0.3s ease;
    }
    
    .message.ai {
        align-self: flex-start;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
    }
    
    .message.user {
        align-self: flex-end;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        color: white;
    }
    
    .message-time {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-top: var(--spacing-xs);
        text-align: right;
    }
    
    .chat-input {
        padding: var(--spacing-lg);
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: var(--spacing-md);
    }
    
    .chat-input textarea {
        flex: 1;
        padding: var(--spacing-md);
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        color: var(--text-primary);
        font-family: var(--font-primary);
        font-size: var(--font-size-sm);
        resize: none;
        min-height: 60px;
        max-height: 120px;
    }
    
    .chat-input textarea:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    
    .chat-actions {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }
    
    /* Monthly Analysis */
    .monthly-analysis {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--sp-xl);
    }
    
    .analysis-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
    }
    
    .analysis-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }
    
    .analysis-trend {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: var(--font-size-sm);
        font-weight: 600;
    }
    
    .trend-up {
        color: var(--success-color);
    }
    
    .trend-down {
        color: var(--danger-color);
    }
    
    .monthly-chart {
        height: 200px;
        position: relative;
    }
    
    /* FAQ Section */
    .faq-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }
    
    .faq-item {
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--border-light);
    }
    
    .faq-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .faq-question {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        cursor: pointer;
    }
    
    .faq-question h4 {
        font-size: var(--font-size-base);
        font-weight: 600;
        flex: 1;
    }
    
    .faq-answer {
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
        line-height: 1.6;
        padding-left: 40px;
        display: none;
    }
    
    .faq-item.active .faq-answer {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    
    .faq-toggle {
        color: var(--primary-color);
        transition: transform 0.3s ease;
    }
    
    .faq-item.active .faq-toggle {
        transform: rotate(180deg);
    }
    
    /* AI Capabilities */
    .capabilities-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }
    
    .capability-card {
        text-align: center;
        padding: var(--spacing-lg);
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        transition: all var(--transition-normal);
    }
    
    .capability-card:hover {
        transform: translateY(-4px);
        border-color: var(--primary-color);
        box-shadow: var(--elevation-2);
    }
    
    .capability-icon {
        width: 60px;
        height: 60px;
        margin: 0 auto var(--spacing-md);
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        border-radius: var(--border-radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .ai-header {
            flex-direction: column;
            text-align: center;
        }
        
        .recommendations-grid {
            grid-template-columns: 1fr;
        }
        
        .monthly-analysis {
            grid-template-columns: 1fr;
        }
        
        .chat-messages {
            height: 300px;
        }
        
        .message {
            max-width: 90%;
        }
        
        .capabilities-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- AI Header -->
<div class="ai-header">
    <div class="ai-avatar">
        <i class="fas fa-robot"></i>
    </div>
    <div class="ai-greeting">
        <h2>Olá, {{ session.full_name or session.username }}!</h2>
        <p>Sou seu assistente de IA financeira. Analisei seus dados e tenho insights para compartilhar.</p>
        <div class="ai-status">
            <div class="status-dot"></div>
            <span>Analisando dados em tempo real</span>
        </div>
    </div>
</div>

<!-- Recommendations -->
<div class="section-header">
    <h3><i class="fas fa-lightbulb"></i> Recomendações da IA</h3>
    <p>Baseado na análise dos seus últimos meses</p>
</div>

<div class="recommendations-grid">
    {% for rec in recommendations %}
    <div class="recommendation-card recommendation-{{ rec.type }}">
        <div class="recommendation-header">
            <div class="recommendation-icon">
                <i class="fas fa-{{ rec.icon }}"></i>
            </div>
            <div>
                <div class="recommendation-title">{{ rec.title }}</div>
                <div class="recommendation-description">{{ rec.description }}</div>
            </div>
        </div>
        <a href="#" class="recommendation-action" onclick="executeRecommendation('{{ rec.action }}')">
            <i class="fas fa-play"></i>
            {{ rec.action }}
        </a>
    </div>
    {% endfor %}
</div>

<!-- Monthly Analysis -->
<div class="section-header">
    <h3><i class="fas fa-chart-line"></i> Análise Mensal</h3>
    <p>Comparativo dos últimos 4 meses</p>
</div>

<div class="monthly-analysis">
    <div class="analysis-card">
        <div class="analysis-header">
            <h4>Receitas</h4>
            {% set income_trend = ((monthly_data[-1].income - monthly_data[0].income) / monthly_data[0].income * 100) if monthly_data[0].income > 0 else 0 %}
            <div class="analysis-trend">
                {% if income_trend > 0 %}
                    <i class="fas fa-arrow-up trend-up"></i>
                    <span class="trend-up">+{{ "%.1f"|format(income_trend) }}%</span>
                {% else %}
                    <i class="fas fa-arrow-down trend-down"></i>
                    <span class="trend-down">{{ "%.1f"|format(income_trend) }}%</span>
                {% endif %}
            </div>
        </div>
        <div class="monthly-chart">
            <canvas id="incomeChart"></canvas>
        </div>
    </div>
    
    <div class="analysis-card">
        <div class="analysis-header">
            <h4>Despesas</h4>
            {% set expense_trend = ((monthly_data[-1].expense - monthly_data[0].expense) / monthly_data[0].expense * 100) if monthly_data[0].expense > 0 else 0 %}
            <div class="analysis-trend">
                {% if expense_trend < 0 %}
                    <i class="fas fa-arrow-down trend-up"></i>
                    <span class="trend-up">{{ "%.1f"|format(expense_trend) }}%</span>
                {% else %}
                    <i class="fas fa-arrow-up trend-down"></i>
                    <span class="trend-down">+{{ "%.1f"|format(expense_trend) }}%</span>
                {% endif %}
            </div>
        </div>
        <div class="monthly-chart">
            <canvas id="expenseChart"></canvas>
        </div>
    </div>
</div>

<!-- Chat Interface -->
<div class="chat-section">
    <div class="chat-header">
        <div>
            <h4><i class="fas fa-comments"></i> Chat com a IA</h4>
            <p class="text-muted">Faça perguntas sobre suas finanças</p>
        </div>
        <div class="chat-actions">
            <button class="neon-btn sm outline" onclick="clearChat()">
                <i class="fas fa-trash"></i>
                Limpar
            </button>
        </div>
    </div>
    
    <div class="chat-messages" id="chatMessages">
        <!-- Messages will be added here -->
        <div class="message ai">
            Olá! Sou sua assistente de IA financeira. Como posso ajudá-lo hoje?
            <div class="message-time">Agora</div>
        </div>
    </div>
    
    <div class="chat-input">
        <textarea id="chatInput" placeholder="Digite sua pergunta sobre finanças..." 
                  onkeydown="handleChatInput(event)"></textarea>
        <div class="chat-actions">
            <button class="neon-btn primary" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
            <button class="neon-btn outline" onclick="showQuickQuestions()">
                <i class="fas fa-bolt"></i>
            </button>
        </div>
    </div>
</div>

<!-- FAQ Section -->
<div class="faq-section">
    <div class="section-header">
        <h3><i class="fas fa-question-circle"></i> Perguntas Frequentes</h3>
        <p>Tire suas dúvidas sobre finanças</p>
    </div>
    
    <div class="faq-list">
        {% for faq in faqs %}
        <div class="faq-item">
            <div class="faq-question" onclick="toggleFAQ(this)">
                <i class="fas fa-chevron-down faq-toggle"></i>
                <h4>{{ faq.question }}</h4>
            </div>
            <div class="faq-answer">
                {{ faq.answer }}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- AI Capabilities -->
<div class="section-header">
    <h3><i class="fas fa-cogs"></i> Capacidades da IA</h3>
    <p>O que sua assistente pode fazer por você</p>
</div>

<div class="capabilities-grid">
    <div class="capability-card">
        <div class="capability-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <h4>Previsão Financeira</h4>
        <p class="text-muted">Previsão de receitas e despesas futuras</p>
    </div>
    
    <div class="capability-card">
        <div class="capability-icon">
            <i class="fas fa-lightbulb"></i>
        </div>
        <h4>Otimização</h4>
        <p class="text-muted">Sugestões para reduzir despesas</p>
    </div>
    
    <div class="capability-card">
        <div class="capability-icon">
            <i class="fas fa-bullseye"></i>
        </div>
        <h4>Metas Inteligentes</h4>
        <p class="text-muted">Definição de metas realistas</p>
    </div>
    
    <div class="capability-card">
        <div class="capability-icon">
            <i class="fas fa-shield-alt"></i>
        </div>
        <h4>Detecção de Riscos</h4>
        <p class="text-muted">Alertas proativos sobre problemas</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar gráficos
        initIncomeChart();
        initExpenseChart();
        
        // Configurar FAQ
        setupFAQ();
        
        // Carregar histórico do chat
        loadChatHistory();
    });
    
    // Gráfico de Receitas
    function initIncomeChart() {
        const ctx = document.getElementById('incomeChart').getContext('2d');
        const monthlyData = {{ monthly_data|tojson }};
        
        const labels = monthlyData.map(m => m.month);
        const incomes = monthlyData.map(m => m.income);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Receitas',
                    data: incomes,
                    borderColor: '#00ff88',
                    backgroundColor: 'rgba(0, 255, 136, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `R$ ${context.parsed.y.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                elements: {
                    line: {
                        tension: 0.4
                    }
                }
            }
        });
    }
    
    // Gráfico de Despesas
    function initExpenseChart() {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        const monthlyData = {{ monthly_data|tojson }};
        
        const labels = monthlyData.map(m => m.month);
        const expenses = monthlyData.map(m => m.expense);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Despesas',
                    data: expenses,
                    borderColor: '#ff3366',
                    backgroundColor: 'rgba(255, 51, 102, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `R$ ${context.parsed.y.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                elements: {
                    line: {
                        tension: 0.4
                    }
                }
            }
        });
    }
    
    // Sistema de Chat
    let chatHistory = [];
    
    function loadChatHistory() {
        const saved = localStorage.getItem('ai_chat_history');
        if (saved) {
            chatHistory = JSON.parse(saved);
            renderChatHistory();
        }
    }
    
    function saveChatHistory() {
        localStorage.setItem('ai_chat_history', JSON.stringify(chatHistory));
    }
    
    function renderChatHistory() {
        const container = document.getElementById('chatMessages');
        container.innerHTML = '';
        
        chatHistory.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.sender}`;
            messageDiv.innerHTML = `
                ${msg.text}
                <div class="message-time">${msg.time}</div>
            `;
            container.appendChild(messageDiv);
        });
        
        container.scrollTop = container.scrollHeight;
    }
    
    function sendMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        
        if (!text) return;
        
        // Adicionar mensagem do usuário
        const userMessage = {
            sender: 'user',
            text: text,
            time: getCurrentTime()
        };
        
        chatHistory.push(userMessage);
        renderChatHistory();
        input.value = '';
        
        // Simular resposta da IA
        setTimeout(() => {
            const aiResponse = generateAIResponse(text);
            chatHistory.push(aiResponse);
            renderChatHistory();
            saveChatHistory();
        }, 1000);
    }
    
    function handleChatInput(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }
    
    function generateAIResponse(userInput) {
        const input = userInput.toLowerCase();
        let response = '';
        
        // Respostas baseadas em palavras-chave
        if (input.includes('economizar') || input.includes('poupar')) {
            response = `Baseado nos seus dados, recomendo: 
1. Reduzir despesas com "Lazer" em 15%
2. Automatizar transferências para poupança
3. Revisar assinaturas mensais`;
        } else if (input.includes('investir') || input.includes('investimento')) {
            response = `Para seus perfis, sugiro:
1. Reserva de emergência (6 meses de despesas)
2. Tesouro Direto IPCA+ para longo prazo
3. CDBs de bancos digitais para médio prazo`;
        } else if (input.includes('meta') || input.includes('objetivo')) {
            response = `Suas metas atuais estão ${avg_progress}% concluídas. 
Sugiro ajustar prazos ou aumentar contribuições mensais.`;
        } else if (input.includes('dívida') || input.includes('divida')) {
            response = `Recomendo o método bola de neve:
1. Liste todas as dívidas do menor ao maior valor
2. Foque em pagar a menor primeiro
3. Mantenha pagamentos mínimos nas outras`;
        } else {
            response = `Entendi sua pergunta sobre "${userInput}". 
Para uma análise mais precisa, posso examinar seus dados específicos. 
Você gostaria de uma análise detalhada sobre algum aspecto em particular?`;
        }
        
        return {
            sender: 'ai',
            text: response,
            time: getCurrentTime()
        };
    }
    
    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString('pt-BR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }
    
    function clearChat() {
        if (confirm('Limpar todo o histórico do chat?')) {
            chatHistory = [];
            localStorage.removeItem('ai_chat_history');
            renderChatHistory();
        }
    }
    
    function showQuickQuestions() {
        const questions = [
            "Como posso economizar mais?",
            "Quais são os melhores investimentos?",
            "Como reduzir minhas despesas?",
            "Minhas metas estão realistas?",
            "Previsão para próximo mês"
        ];
        
        const modal = document.createElement('div');
        modal.className = 'neon-modal active';
        modal.innerHTML = `
            <div class="neon-modal-content">
                <div class="neon-modal-header">
                    <h3><i class="fas fa-bolt"></i> Perguntas Rápidas</h3>
                    <button class="neon-modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="neon-modal-body">
                    <div class="quick-questions">
                        ${questions.map(q => `
                            <button class="quick-question-btn" onclick="selectQuestion('${q}')">
                                ${q}
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        window.closeModal = function() {
            modal.classList.remove('active');
            setTimeout(() => modal.remove(), 300);
        };
    }
    
    function selectQuestion(question) {
        document.getElementById('chatInput').value = question;
        closeModal();
        document.getElementById('chatInput').focus();
    }
    
    // FAQ System
    function setupFAQ() {
        document.querySelectorAll('.faq-question').forEach(question => {
            question.addEventListener('click', function() {
                const item = this.closest('.faq-item');
                item.classList.toggle('active');
            });
        });
    }
    
    function toggleFAQ(element) {
        const item = element.closest('.faq-item');
        item.classList.toggle('active');
    }
    
    // Execute Recommendations
    function executeRecommendation(action) {
        showLoading('Executando ação...');
        
        setTimeout(() => {
            hideLoading();
            
            let message = '';
            
            if (action.includes('Revise')) {
                message = 'Redirecionando para a página de transações...';
                setTimeout(() => {
                    window.location.href = '/transactions';
                }, 1000);
            } else if (action.includes('Tente aumentar')) {
                message = 'Configurando meta automática de poupança...';
                // Implementar criação automática de meta
            } else if (action.includes('Considere diversificar')) {
                message = 'Analisando categorias de despesa...';
                // Implementar análise de categorias
            } else if (action.includes('Ajuste o prazo')) {
                message = 'Abrindo edição de metas...';
                setTimeout(() => {
                    window.location.href = '/goals';
                }, 1000);
            }
            
            if (message) {
                showNotification(message, 'success');
            }
        }, 1500);
    }
    
    // Advanced AI Analysis
    function runAdvancedAnalysis() {
        showLoading('Executando análise avançada...');
        
        setTimeout(() => {
            hideLoading();
            
            const analysis = {
                riskScore: calculateRiskScore(),
                opportunities: findOpportunities(),
                predictions: generatePredictions()
            };
            
            showAnalysisResults(analysis);
        }, 3000);
    }
    
    function calculateRiskScore() {
        // Simulação de cálculo de risco
        const monthlyData = {{ monthly_data|tojson }};
        const latest = monthlyData[monthlyData.length - 1];
        
        let score = 50;
        
        if (latest.expense > latest.income) score += 30;
        if ((latest.expense / latest.income) > 0.8) score += 20;
        
        return Math.min(100, score);
    }
    
    function findOpportunities() {
        return [
            'Redução de 15% possível em categorias de lazer',
            'Oportunidade de investimento em renda fixa',
            'Revisão de seguros pode economizar até R$ 200/mês'
        ];
    }
    
    function generatePredictions() {
        return {
            nextMonth: {
                income: 'Crescimento de 5% esperado',
                expense: 'Estável com possível redução de 3%',
                savings: 'Potencial aumento de 8% na poupança'
            },
            nextQuarter: {
                projection: 'Acumulação positiva de R$ 2.500',
                recommendations: 'Considerar investimentos de médio prazo'
            }
        };
    }
    
    function showAnalysisResults(analysis) {
        const modal = document.createElement('div');
        modal.className = 'neon-modal active';
        modal.innerHTML = `
            <div class="neon-modal-content" style="max-width: 700px;">
                <div class="neon-modal-header">
                    <h3><i class="fas fa-chart-network"></i> Análise Avançada</h3>
                    <button class="neon-modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="neon-modal-body">
                    <div class="analysis-results">
                        <div class="risk-score">
                            <h4>Score de Risco</h4>
                            <div class="score-display">
                                <div class="score-value">${analysis.riskScore}/100</div>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${analysis.riskScore}%;
                                        background: ${analysis.riskScore > 70 ? '#ff3366' : 
                                                    analysis.riskScore > 40 ? '#ff9900' : '#00ff88'};">
                                    </div>
                                </div>
                                <div class="score-label">
                                    ${analysis.riskScore > 70 ? 'Alto Risco' : 
                                      analysis.riskScore > 40 ? 'Risco Moderado' : 'Baixo Risco'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="opportunities">
                            <h4>Oportunidades Identificadas</h4>
                            <ul>
                                ${analysis.opportunities.map(opp => `
                                    <li><i class="fas fa-check"></i> ${opp}</li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <div class="predictions">
                            <h4>Previsões</h4>
                            <div class="prediction-grid">
                                <div class="prediction-card">
                                    <h5>Próximo Mês</h5>
                                    <p>${analysis.predictions.nextMonth.income}</p>
                                    <p>${analysis.predictions.nextMonth.expense}</p>
                                    <p>${analysis.predictions.nextMonth.savings}</p>
                                </div>
                                <div class="prediction-card">
                                    <h5>Próximo Trimestre</h5>
                                    <p>${analysis.predictions.nextQuarter.projection}</p>
                                    <p>${analysis.predictions.nextQuarter.recommendations}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="neon-modal-footer">
                    <button class="neon-btn primary" onclick="exportAnalysis()">
                        <i class="fas fa-download"></i>
                        Exportar Análise
                    </button>
                    <button class="neon-btn outline" onclick="closeModal()">
                        Fechar
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        window.closeModal = function() {
            modal.classList.remove('active');
            setTimeout(() => modal.remove(), 300);
        };
    }
    
    function exportAnalysis() {
        showNotification('Exportando análise completa...', 'info');
        // Implementar exportação
    }
    
    // Utility Functions
    function showLoading(message) {
        const loading = document.createElement('div');
        loading.id = 'aiLoading';
        loading.innerHTML = `
            <div class="neon-loader"></div>
            <div class="loading-text">${message}</div>
        `;
        loading.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;
        document.body.appendChild(loading);
    }
    
    function hideLoading() {
        const loading = document.getElementById('aiLoading');
        if (loading) {
            loading.style.opacity = '0';
            setTimeout(() => loading.remove(), 300);
        }
    }
    
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `flash-message flash-${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
            <span>${message}</span>
            <button class="flash-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        const container = document.querySelector('.flash-messages');
        if (container) {
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
    }
    
    // Adicionar botão de análise avançada
    document.addEventListener('DOMContentLoaded', function() {
        const header = document.querySelector('.ai-header');
        if (header) {
            const analyzeBtn = document.createElement('button');
            analyzeBtn.className = 'neon-btn accent';
            analyzeBtn.innerHTML = '<i class="fas fa-chart-network"></i> Análise Avançada';
            analyzeBtn.onclick = runAdvancedAnalysis;
            analyzeBtn.style.marginLeft = 'auto';
            header.appendChild(analyzeBtn);
        }
    });
</script>

<style>
    .quick-questions {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }
    
    .quick-question-btn {
        padding: var(--spacing-md);
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        color: var(--text-primary);
        text-align: left;
        cursor: pointer;
        transition: all var(--transition-fast);
        font-family: var(--font-primary);
        font-size: var(--font-size-sm);
    }
    
    .quick-question-btn:hover {
        background: var(--bg-surface);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .analysis-results {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
    }
    
    .risk-score {
        text-align: center;
        padding: var(--spacing-lg);
        background: var(--bg-tertiary);
        border-radius: var(--border-radius-lg);
    }
    
    .score-display {
        margin-top: var(--spacing-md);
    }
    
    .score-value {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: var(--spacing-md);
        font-family: var(--font-mono);
    }
    
    .score-bar {
        height: 20px;
        background: var(--bg-surface);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: var(--spacing-sm);
    }
    
    .score-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 1s ease;
    }
    
    .score-label {
        font-size: var(--font-size-sm);
        font-weight: 600;
    }
    
    .opportunities ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .opportunities li {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) 0;
        border-bottom: 1px solid var(--border-light);
    }
    
    .opportunities li:last-child {
        border-bottom: none;
    }
    
    .opportunities li i {
        color: var(--success-color);
        margin-top: 2px;
    }
    
    .prediction-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
    }
    
    .prediction-card {
        padding: var(--spacing-md);
        background: var(--bg-tertiary);
        border-radius: var(--border-radius-md);
        border: 1px solid var(--border-color);
    }
    
    .prediction-card h5 {
        margin-bottom: var(--spacing-sm);
        color: var(--primary-color);
    }
    
    .prediction-card p {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
    }
</style>
{% endblock %}